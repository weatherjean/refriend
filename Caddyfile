# Caddyfile for Riff
# Caddy automatically handles Let's Encrypt SSL certificates

{$DOMAIN:localhost} {
    # Enable compression
    encode gzip zstd

    # Logging
    log {
        output stdout
        format console
    }

    # Backend routes (API, well-known, federation infrastructure)
    @backend {
        path /api/* /.well-known/* /nodeinfo/* /inbox /health
    }
    handle @backend {
        reverse_proxy api:8000
    }

    # Legacy /users/ redirect to /@
    redir /users/{path} /@{path} permanent

    # ActivityPub content negotiation for /@* paths
    @ap_request {
        path /@*
        header_regexp Accept (application/activity\+json|application/ld\+json)
    }
    handle @ap_request {
        reverse_proxy api:8000
    }

    # Everything else (including browser /@* requests) -> SPA
    handle {
        root * /srv/web
        try_files {path} /index.html
        file_server
    }
}
