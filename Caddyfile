# Caddyfile for Riff
# Caddy automatically handles Let's Encrypt SSL certificates

{$DOMAIN:localhost} {
    encode gzip zstd

    log {
        output stdout
        format console
        level WARN
    }

    # Legacy /users/ redirect to /@
    redir /users/{path} /@{path} permanent

    # Backend routes: API, federation, and /@* (ActivityPub actors/posts)
    @backend {
        path /api/* /.well-known/* /nodeinfo/* /inbox /health /@*
    }
    handle @backend {
        reverse_proxy api:8000
    }

    # Everything else -> SPA (including /a/* profile pages)
    handle {
        root * /srv/web
        try_files {path} /index.html
        file_server
    }
}

plog.{$DOMAIN:localhost} {
    log {
        output stdout
        format console
        level ERROR
    }
    basicauth {
        zfridau $2a$14$hLD3NKx39qGTCa2YDgK4geIyk7Jkxz3/2Xz6mOYOHuPceQPScGunW
    }
    reverse_proxy dozzle:8080 {
        flush_interval -1
    }
}
